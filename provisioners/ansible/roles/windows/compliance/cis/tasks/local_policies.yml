---

# USER RIGHTS ASSIGNMENT

- name: "CIS,2.2.1,CCE-37056-9 | Ensure 'Access Credential Manager as a trusted caller' is set to 'No One'"
  win_user_right:
     name: SeTrustedCredManAccessPrivilege
     users: []
     action: set
  tags: ['configuration']

# In case it's necessary to assign this right to the 'Authenticated Users' group, it should also be included
- name: "CIS,2.2.2,CCE-35818-4 | Ensure 'Access this computer from the network' is set to 'Administrators, Remote Desktop Users'"
  win_user_right:
     name: SeNetworkLogonRight
     users:
     - '{{ group_administrators }}'
     - '{{ group_remote_desktop }}'
     #- '{{ group_auth_users }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.3,CCE-36876-1 | Ensure 'Act as part of the operating system' is set to 'No One'"
  win_user_right:
     name: SeTcbPrivilege
     users: []
     action: set
  tags: ['configuration']

- name: "CIS,2.2.4,CCE-37071-8 | Ensure 'Adjust memory quotas for a process' is set to 'Administrators, LOCAL SERVICE, NETWORK SERVICE'"
  win_user_right:
     name: SeIncreaseQuotaPrivilege
     users:
     - '{{ group_administrators }}'
     - '{{ group_local_service }}'
     - '{{ group_network_service }}'
     action: set
  tags: ['configuration']

# This is the recommended value according to the CIS Benchmarks
# If a specific user or group of users needs this right as well (for doing specific administrative roles) they will need to be configured
# In case the organization also needs the Backup Operators accounts to be assigned this user right
# The most secure option is only 'Administrators', but doesn't allow any other type of local session
- name: "CIS,2.2.5,CCE-37659-0 | Ensure 'Allow log on locally' is set to 'Administrators, Users'"
  win_user_right:
     name: SeInteractiveLogonRight
     users:
     - '{{ group_administrators }}'
     - '{{ group_auth_users }}'
     #- '{{ group_backup_operators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.6,CCE-37072-6 | Ensure 'Allow log on through Remote Desktop Services' is set to 'Administrators, Remote Desktop Users'"
  win_user_right:
     name: SeRemoteInteractiveLogonRight
     users:
     - '{{ group_administrators }}'
     - '{{ group_remote_desktop }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.7,CCE-35912-5 | Ensure 'Back up files and directories' is set to 'Administrators'"
  win_user_right:
     name: SeBackupPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.8,CCE-37452-0 | Ensure 'Change the system time' is set to 'Administrators, LOCAL SERVICE'"
  win_user_right:
     name: SeSystemTimePrivilege
     users:
     - '{{ group_administrators }}'
     - '{{ group_local_service }}'
     action: set
  tags: ['configuration']

# Changing the time zone represents little vulnerability since the system time is not affected, so it might be useful for normal users to be able to change the time according to their preferences
- name: "CIS,2.2.9,CCE-37700-2 | Ensure 'Change the time zone' is set to 'Administrators, LOCAL SERVICE'"
  win_user_right:
     name: SeTimeZonePrivilege
     users:
     - '{{ group_administrators }}'
     - '{{ group_local_service }}'
     #- '{{ group_users }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.10,CCE-35821-8 | Ensure 'Create a pagefile' is set to 'Administrators'"
  win_user_right:
     name: SeCreatePagefilePrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.11,CCE-36861-3 | Ensure 'Create a token object' is set to 'No One'"
  win_user_right:
     name: SeCreateTokenPrivilege
     users: []
     action: set
  tags: ['configuration']

- name: "CIS,2.2.12,CCE-37453-8 | Ensure 'Create global objects' is set to 'Administrators, LOCAL SERVICE, NETWORK SERVICE, SERVICE'"
  win_user_right:
     name: SeCreateGlobalPrivilege
     users:
     - '{{ group_administrators }}'
     - '{{ group_local_service }}'
     - '{{ group_network_service }}'
     - '{{ group_service }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.13,CCE-36532-0 | Ensure 'Create permanent shared objects' is set to 'No One'"
  win_user_right:
     name: SeCreatePermanentPrivilege
     users: []
     action: set
  tags: ['configuration']

- name: "CIS,2.2.14,CCE-35823-4 | Configure 'Create symbolic links'"
  win_user_right:
     name: SeCreateSymbolicLinkPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.15,CCE-37075-9 | Ensure 'Debug programs' is set to 'Administrators'"
  win_user_right:
     name: SeDebugPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

# Limiting hardening to only include the Guests group, because Local Account access will still be needed for standalone workstations
# If you're configuring a domain-joined workstation, you may need to uncomment the local account variable reference
- name: "CIS,2.2.16,CCE-37954-5 | Configure 'Deny access to this computer from the network'"
  win_user_right:
     name: SeDenyNetworkLogonRight
     users:
     - '{{ group_guests }}'
     #- '{{ group_local_account }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.17,CCE-36923-1 | Ensure 'Deny log on as a batch job' to include 'Guests'"
  win_user_right:
     name: SeDenyBatchLogonRight
     users:
     - '{{ group_guests }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.18,CCE-36877-9 | Ensure 'Deny log on as a service' to include 'Guests'"
  win_user_right:
     name: SeDenyServiceLogonRight
     users:
     - '{{ group_guests }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.19,CCE-37146-8 | Ensure 'Deny log on locally' to include 'Guests'"
  win_user_right:
     name: SeDenyInteractiveLogonRight
     users:
     - '{{ group_guests }}'
     action: set
  tags: ['configuration']

# Limiting hardening to only include the Guests group, because Local Account access will still be needed for remotely administering standalone workstations
# If you're configuring a domain-joined workstation, you may want to uncomment the local account variable reference
- name: "CIS,2.2.20,CCE-36867-0 | Configure 'Deny log on through Remote Desktop Services' to include 'Guests'"
  win_user_right:
     name: SeDenyRemoteInteractiveLogonRight
     users:
     - '{{ group_guests }}'
     #- '{{ group_local_account }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.21,CCE-36860-5 | Ensure 'Enable computer and user accounts to be trusted for delegation' is set to 'No One'"
  win_user_right:
     name: SeEnableDelegationPrivilege
     users: []
     action: set
  tags: ['configuration']

- name: "CIS,2.2.22,CCE-37877-8 | Ensure 'Force shutdown from a remote system' is set to 'Administrators'"
  win_user_right:
     name: SeRemoteShutdownPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.23,CCE-37639-2 | Ensure 'Generate security audits' is set to 'LOCAL SERVICE, NETWORK SERVICE'"
  win_user_right:
     name: SeAuditPrivilege
     users:
     - '{{ group_local_service }}'
     - '{{ group_network_service }}'
     action: set
  tags: ['configuration']

# If you have installed Web Server/IIS you will need to assign this user right to IIS_IUSRS as well
- name: "CIS,2.2.24,CCE-37106-2 | Ensure 'Impersonate a client after authentication' is set to 'Administrators, LOCAL SERVICE, NETWORK SERVICE, SERVICE'"
  win_user_right:
     name: SeImpersonatePrivilege
     users:
     - '{{ group_administrators }}'
     #- '{{ group_iis_users }}'
     - '{{ group_local_service }}'
     - '{{ group_network_service }}'
     - '{{ group_service }}'
     action: set
  tags: ['configuration']

# The default value on Windows 10 R1703 or newer is already 'Administrators, Window Manager\Window Manager Group', but on Windows 10 R1607 or older the user right was only set for 'Administrators'
- name: "CIS,2.2.25,CCE-38326-5 | Ensure 'Increase scheduling priority' is set to 'Administrators, Window Manager\\Window Manager Group'"
  win_user_right:
     name: SeIncreaseBasePriorityPrivilege
     users:
     - '{{ group_administrators }}'
     - '{{ group_window_manager }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.26,CCE-36318-4 | Ensure 'Load and unload device drivers' is set to 'Administrators'"
  win_user_right:
     name: SeLoadDriverPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.27,CCE-36495-0 | Ensure 'Lock pages in memory' is set to 'No One'"
  win_user_right:
     name: SeLockMemoryPrivilege
     users: []
     action: set
  tags: ['configuration']

# Both CIS 2.2.28 and 2.2.29 are classified as L2 (High Security/Sensitive Data Environment), so for most organizations, the default settings are sufficient

- name: "CIS,2.2.30,CCE-35906-7 | Configure 'Manage auditing and security log' is set to 'Administrators'"
  win_user_right:
     name: SeSecurityPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.31,CCE-36054-5 | Ensure 'Modify an object label' is set to 'No One'"
  win_user_right:
     name: SeReLabelPrivilege
     users: []
     action: set
  tags: ['configuration']

- name: "CIS,2.2.32,CCE-38113-7 | Ensure 'Modify firmware environment values' is set to 'Administrators'"
  win_user_right:
     name: SeSystemEnvironmentPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.33,CCE-36143-6 | Ensure 'Perform volume maintenance tasks' is set to 'Administrators'"
  win_user_right:
     name: SeManageVolumePrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.34,CCE-37131-0 | Ensure 'Profile single process' is set to 'Administrators'"
  win_user_right:
     name: SeProfileSingleProcessPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

- name: "CIS,2.2.35,CCE-36052-9 | Ensure 'Profile system performance' is set to 'Administrators, NT SERVICE\\WdiServiceHost'"
  win_user_right:
     name: SeSystemProfilePrivilege
     users:
     - '{{ group_administrators }}'
     - NT SERVICE\WdiServiceHost
     action: set
  tags: ['configuration']

- name: "CIS,2.2.36,CCE-37430-6 | Ensure 'Replace a process level token' is set to 'LOCAL SERVICE, NETWORK SERVICE'"
  win_user_right:
     name: SeAssignPrimaryTokenPrivilege
     users:
     - '{{ group_local_service }}'
     - '{{ group_network_service }}'
     action: set
  tags: ['configuration']

# The default value for this policy also includes 'Backup Operators'. You should make sure that users that have been delegated specific tasks won't negatively affected
- name: "CIS,2.2.37,CCE-37613-7 | Ensure 'Restore files and directories' is set to 'Administrators'"
  win_user_right:
     name: SeRestorePrivilege
     users:
     - '{{ group_administrators }}'
     #- '{{ group_backup_operators }}'
     action: set
  tags: ['configuration']

# Generally, Administrators and authorized users of the workstations should have this right available; it shouldn't be granted to guests and other unauthorized users
- name: "CIS,2.2.38,CCE-38328-1 | Ensure 'Shut down the system' is set to 'Administrators, 'Users'"
  win_user_right:
     name: SeShutdownPrivilege
     users:
     - '{{ group_administrators }}'
     - '{{ group_users }}'
     action: set
  when: (unprivileged_shutdown_allowed|default(True) == False)
  tags: ['configuration']

- name: "CIS,2.2.39,CCE-38325-7 | Ensure 'Take ownership of files or other objects' is set to 'Administrators'"
  win_user_right:
     name: SeTakeOwnershipPrivilege
     users:
     - '{{ group_administrators }}'
     action: set
  tags: ['configuration']

# SECURITY OPTIONS

# According to the CIS benchmarks, it's recommended to disable the built-in Administrator account for several security reasons
# However, some maintenance issues could arise if this account is disabled, so make sure if your organization requires this setting to be enabled or disabled
# In any case, the default value for this setting is 'Disabled'
- name: "CIS,2.3.1.1,CCE-37953-7 | Ensure 'Accounts: Administrator account status' is set to 'Disabled'"
  win_security_policy:
     section: System Access
     key: EnableAdminAccount
     value: "0" # Disabled
  tags: ['configuration']

# Depending on the system and the organization, it's necessary to keep the Administrator account enabled
#- name: "CIS,2.3.1.1,CCE-37953-7 | Ensure 'Accounts: Administrator account status' is set to {{ (enable_admin_account|default(True) == True) | ternary('Enabled', 'Disabled') }}"
#  win_security_policy:
#     section: System Access
#     key: EnableAdminAccount
#     value: "{{ (enable_admin_account|default(True) == True) | ternary('1', '0') }}" 
#  tags: ['configuration']

# If set as the recommended, then users won't be able to log onto the computer with their Microsoft account
- name: "CIS,2.3.1.2,CCE-36147-7 | Ensure 'Accounts: Block Microsoft accounts' is set to 'Users can't add or log on with Microsoft accounts'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "NoConnectedUser"
     data: "3" # option 'Users can't add or log on with Microsoft accounts'
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.1.3,CCE-37432-2 | Ensure 'Accounts: Guest account status' is set to 'Disabled'"
  win_security_policy:
     section: System Access
     key: EnableGuestAccount
     value: "0" # Disabled
  tags: ['configuration']

- name: "CIS,2.3.1.4,CCE-37615-2 | Ensure 'Accounts: Limit local account use of blank passwords to console logon only' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Lsa
     name: "LimitBlankPasswordUse"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# The built-in local admin account is a well-known account name and so it'll be a probable target in an attack
# It is recommended to change the name of this account, so it could be slightly more difficult for a unauthorized persons to guess the name and password combination of this account 
- name: "CIS,2.3.1.5,CCE-38233-3 | Configure 'Accounts: Rename administrator account'"
  win_security_policy:
     section: System Access
     key: NewAdministratorName
     value: '{{ adminaccountnewname }}'
  tags: ['configuration']

# The built-in local guest account is a well-known account name and so it'll be a probable target in an attack
# It is recommended to rename this account, even if you disable it, so you gain added security
- name: "CIS,2.3.1.6,CCE-38027-9 | Configure 'Accounts: Rename guest account'"
  win_security_policy:
     section: System Access
     key: NewGuestName
     value: '{{ guestaccountnewname }}'
  tags: ['configuration']

# AUDIT

- name: "CIS,2.3.2.1,CCE-37850-5 | Ensure 'Audit: Force audit policy subcategory settings (Windows Vista or later) to override audit policy category settings' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Lsa
     name: "SCENoApplyLegacyAuditPolicy"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# If this setting is enabled, unplanned system failures can occur and cause a significant administrative burden
# Attackers could potentially generate large volumes of log data to force a shutdown on purpose; also, non graceful shutdowns could lead to irreparable damage to the OS, applications or data
- name: "CIS,2.3.2.2,CCE-35907-5 | Ensure 'Audit: Shut down system immediately if unable to log security audits' is set to 'Disabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Lsa
     name: "CrashOnAuditFail"
     data: "0" # Disabled
     type: dword
  tags: ['configuration']

# DEVICES

- name: "CIS,2.3.4.1,CCE-37701-0 | Ensure 'Devices: Allowed to format and eject removable media' is set to 'Administrators and Interactive Users'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows Nt\CurrentVersion\Winlogon
     name: "AllocateDASD"
     data: "0" # Administrators and Interactive Users
     type: string
  tags: ['configuration']

- name: "CIS,2.3.4.2,CCE-37942-0 | Ensure 'Devices: Prevent users from installing printer drivers' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Print\Providers\Lanman Print Services\Servers
     name: "AddPrinterDrivers"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# DOMAIN MEMBER

- name: "CIS,2.3.6.1,CCE-36142-8 | Ensure 'Domain member: Digitally encrypt or sign secure channel data (always)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
     name: "RequireSignOrSeal"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.6.2,CCE-37130-2 | Ensure 'Domain member: Digitally encrypt secure channel data (when possible)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
     name: "SealSecureChannel"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.6.3,CCE-37222-7 | Ensure 'Domain member: Digitally sign secure channel data (when possible)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
     name: "SignSecureChannel"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.6.4,CCE-37508-9 | Ensure 'Domain member: Disable machine account password changes' is set to 'Disabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
     name: "DisablePasswordChange"
     data: "0" # Disabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.6.5,CCE-37431-4 | Ensure 'Domain member: Maximum machine account password age' is set to '30 or fewer days, but not 0'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
     name: "MaximumPasswordAge"
     data: '{{ maximummachineaccountpasswordage }}'
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.6.6,CCE-37614-5 | Ensure 'Domain member: Require strong (Windows 2000 or later) session key' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
     name: "RequireStrongKey"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# INTERACTIVE LOGON

- name: "CIS,2.3.7.1,CCE-37637-6 | Ensure 'Interactive logon: Do not require CTRL+ALT+DEL' is set to 'Disabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
     name: "DisableCAD"
     data: "0" # Disabled 
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.7.2,CCE-36056-0 | Ensure 'Interactive logon: Don't display last signed-in' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
     name: "DontDisplayLastUserName"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.7.4,CCE-38235-8 | Ensure 'Interactive logon: Machine inactivity limit' is set to '900 or fewer second(s), but not 0'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
     name: "InactivityTimeoutSecs"
     data: '{{ machineinactivitylimit }}'
     type: dword
  tags: ['configuration']

# By displaying a custom warning message before logon organizations could prevent an attack, warning the possible attackers of legal consequences of their misconduct
# Also, it could help reinforcing corporate policy informing employees via this message
# If you wish to configure this setting, you should get approval from your organization's legal and HR representatives about the displayed warning
- name: "CIS,2.3.7.5,CCE-37226-8 | Configure 'Interactive logon: Message text for users attempting to log on'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
     name: "LegalNoticeText"
     data: '{{ legal_notice_text }}'
     type: string
  when: (show_legal_notice|default(False) == True)
  tags: ['configuration']

# By displaying a custom warning message before logon organizations could prevent an attack, warning the possible attackers of legal consequences of their misconduct
# Also, it could help reinforcing corporate policy informing employees via this message
# If you wish to configure this setting, you should get approval from your organization's legal and HR representatives about the displayed warning
- name: "CIS,2.3.7.6,CCE-37512-1 | Configure 'Interactive logon: Message title for users attempting to log on'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
     name: "LegalNoticeCaption"
     data: '{{ legal_notice_caption }}'
     type: string
  when: (show_legal_notice|default(False) == True)
  tags: ['configuration']

# L2
- name: "CIS,2.3.7.7,CCE-37439-7 | Ensure 'Interactive logon: Number of previous logons to cache (in case domain controller is not available)' is set to '4 or fewer logon(s)'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
     name: "cachedlogonscount"
     data: "1"
     type: string
  when: (l2_environment|default(False) == True)
  tags: ['configuration']

- name: "CIS,2.3.7.8,CCE-37622-8 | Ensure 'Interactive logon: Prompt user to change password before expiration' is set to 'between 5 and 14 days'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
     name: "PasswordExpiryWarning"
     data: '{{ dayspromptchangebeforeexpiration }}'
     type: dword
  tags: ['configuration']

# If smart cards are used for authentication, then removal of said card should make the computer to automatically lock itself to ensure only the user with the smart card is accessing resources using their credentials
# Configuring this setting to Force Logoff or Disconnect if a Remote Desktop Services session also conforms to the benchmark
# However, it is recommended that this setting is enforced on workstations used for purposes commonly associated with typical users, as enforcing this setting on computers used by people who have to log onto multiple computers for certain tasks can be troublesome and be limited
- name: "CIS,2.3.7.9,CCE-38333-1 | Ensure 'Interactive logon: Smart card removal behavior' is set to 'Lock Workstation' or higher"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
     name: "ScRemoveOption"
     data: "1" # Lock Workstation
     type: string
  tags: ['configuration']

# MICROSOFT NETWORK CLIENT

- name: "CIS,2.3.8.1,CCE-36325-9 | Ensure 'Microsoft network client: Digitally sign communications (always)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\LanmanWorkstation\Parameters
     name: "RequireSecuritySignature"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.8.2,CCE-36269-9 | Ensure 'Microsoft network client: Digitally sign communications (if server agrees)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\LanmanWorkstation\Parameters
     name: "EnableSecuritySignature"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.8.3,CCE-37863-8 | Ensure 'Microsoft network client: Send unencrypted password to third-party SMB servers' is set to 'Disabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters
     name: "EnablePlainTextPassword"
     data: "0" # Disabled
     type: dword
  tags: ['configuration']

# MICROSOFT NETWORK SERVER

- name: "CIS,2.3.9.1,CCE-38046-9 | Ensure 'Microsoft network server: Amount of idle time required before suspending session' is set to '15 or fewer minute(s)"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
     name: "AutoDisconnect"
     data: '{{ idletimebeforesuspendingsmbsession }}'
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.9.2,CCE-37864-6 | Ensure 'Microsoft network server: Digitally sign communications (always)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
     name: "RequireSecuritySignature"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.9.3,CCE-35988-5 | Ensure 'Microsoft network server: Digitally sign communications (if client agrees)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
     name: "EnableSecuritySignature"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# If your organization configures logon hours for users, then it makes sense to enable this policy setting, as it is necessary to ensure logon hours are effective
- name: "CIS,2.3.9.4,CCE-37972-7 | Ensure 'Microsoft network server: Disconnect clients when logon hours expire' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
     name: "EnableForcedLogoff"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# The recommended state for this setting is 'Accept if provided by client', but configuring this setting to 'Required from client' also conforms to the benchmark
- name: "CIS,2.3.9.5,CCE-36170-9 | Ensure 'Microsoft network server: Server SPN target name validation level' is set to 'Accept if provided by client' or higher"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
     name: "SMBServerNameHardeningLevel"
     data: '{{ required_from_client }}' # Required from client
     type: dword
  tags: ['configuration']

# NETWORK ACCESS

- name: "CIS,2.3.10.1,CCE-36065-1 | Ensure 'Network access: Allow anonymous SID/Name translation' is set to 'Disabled'"
  win_security_policy:
     section: System Access
     key: LSAAnonymousNameLookup
     value: "0" # Disabled
  tags: ['configuration']

- name: "CIS,2.3.10.2,CCE-36316-8 | Ensure 'Network access: Do not allow anonymous enumeration of SAM accounts' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Lsa
     name: "RestrictAnonymousSAM"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.10.3,CCE-36077-6 | Ensure 'Network access: Do not allow anonymous enumeration of SAM accounts and shares' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Lsa
     name: "RestrictAnonymous"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# Enabling this setting makes it impossible to specify alternate credentials for scheduled tasks, which can cause a variety of problems such as some third party backup products no longer working
# This policy however will have no impact on users who access network resources that are configured to allow access with their Active Directory-based domain account
- name: "CIS,2.3.10.4,CCE-36148-5 | Ensure 'Network access: Do not allow storage of passwords and credentials for network authentication' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa
     name: "DisableDomainCreds"
     data: "1" # Enabled
     type: dword
  when: (not_allow_password_and_credentials_storage_for_network_authentication|default(False) == True)
  tags: ['configuration']

- name: "CIS,2.3.10.5,CCE-36148-5 | Ensure 'Network access: Let Everyone permissions apply to anonymous users' is set to 'Disabled'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa
     name: "EveryoneIncludesAnonymous"
     data: "0" # Disabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.10.6,CCE-38258-0 | Configure 'Network access: Named Pipes that can be accessed anonymously'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
     name: "NullSessionPipes"
     data: ""
     type: multistring
  tags: ['configuration']

# If you want to allow remote access, you must also enable the Remote Registry service.
- name: "CIS,2.3.10.7,CCE-37194-8 | Ensure 'Network access: Remotely accessible registry paths' is configured"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Securepipeservers\Winreg\AllowedExactPaths
     name: "Machine"
     data: ['System\CurrentControlSet\Control\ProductOptions', 'System\CurrentControlSet\Control\Server Applications', 'Software\Microsoft\Windows NT\CurrentVersion']
     type: multistring
  tags: ['configuration']

# If you want to allow remote access, you must also enable the Remote Registry service.
- name: "CIS,2.3.10.8,CCE-36347-3 | Ensure 'Network access: Remotely accessible registry paths and sub-paths' is configured"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Securepipeservers\Winreg\AllowedPaths
     name: "Machine"
     data: ['System\CurrentControlSet\Control\Print\Printers', 'System\CurrentControlSet\Services\Eventlog', 'Software\Microsoft\OLAP Server', 'Software\Microsoft\Windows NT\CurrentVersion\Print', 'Software\Microsoft\Windows NT\CurrentVersion\Windows', 'System\CurrentControlSet\Control\ContentIndex', 'System\CurrentControlSet\Control\Terminal Server', 'System\CurrentControlSet\Control\Terminal Server\UserConfig', 'System\CurrentControlSet\Control\Terminal Server\DefaultUserConfiguration', 'Software\Microsoft\Windows NT\CurrentVersion\Perflib', 'System\CurrentControlSet\Services\SysmonLog']
     type: multistring
  tags: ['configuration']

- name: "CIS,2.3.10.9,CCE-36021-4 | Ensure 'Network access: Restrict anonymous access to Named Pipes and Shares' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Services\LanManServer\Parameters
     name: "RestrictNullSessAccess"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# If your organization is using Azure Advanced Threat Protection (APT), the service account, 'AATP Service' will need to be added to the recommendation configuration
- name: "CIS,2.3.10.10,CCE-Null | Ensure 'Network access: Restrict clients allowed to make remote calls to SAM' is set to 'Administrators: Remote Access: Allow'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa
     name: "RestrictRemoteSAM"
     data: "O:BAG:BAD:(A;;RC;;;BA)"
     type: string
  tags: ['configuration']

- name: "CIS,2.3.10.11,CCE-38095-6 | Ensure 'Network access: Shares that can be accessed anonymously' is set to 'None'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
     name: "NullSessionShares"
     data: ""
     type: multistring
  tags: ['configuration']

# This is the default configuration for domain-jointed computers, while on standalone workstations this value is set to 'Guest only - local users authenticate as Guest' by default
- name: "CIS,2.3.10.12,CCE-37623-6 | Ensure 'Network access: Sharing and security model for local accounts' is set to 'Classic - local users authenticate as themselves'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa
     name: "ForceGuest"
     data: "0" # Classic - local users authenticate as themselves
     type: dword
  tags: ['configuration']

# NETWORK SECURITY

- name: "CIS,2.3.11.1,CCE-38341-4 | Ensure 'Network security: Allow Local System to use computer identity for NTLM' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa
     name: "UseMachineId"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.11.2,CCE-37035-3 | Ensure 'Network security: Allow LocalSystem NULL session fallback' is set to 'Disabled'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
     name: "AllowNullSessionFallback"
     data: "0" # Disabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.11.3,CCE-38047-7 | Ensure 'Network Security: Allow PKU2U authentication requests to this computer to use online identities' is set to 'Disabled'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa\pku2u
     name: "AllowOnlineID"
     data: "0" # Disabled
     type: dword
  tags: ['configuration']

# Default values for this setting are 'RC4_HMAC_MD5, AES128_HMAC_SHA1, AES256_HMAC_SHA1, Future encryption types'
# Some legacy applications and OSes may still require RC4_HMAC_MD5, so it is recommended you test in your environment and verify whether you can safely remove it
- name: "CIS,2.3.11.4,CCE-37755-6 | Ensure 'Network security: Configure encryption types allowed for Kerberos' is set to 'AES128_HMAC_SHA1, AES256_HMAC_SHA1, Future encryption types'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters
     name: "SupportedEncryptionTypes"
     data: "2147483644"
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.11.5,CCE-36326-7 | Ensure 'Network security: Do not store LAN Manager hash value on next password change' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa
     name: "NoLMHash"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# The default behaviour for this policy is 'Enabled' so a clean install complies with the benchmark
# It must be configured manually, there's no registry path for configuring the value manually
#- name: "CIS,2.3.11.6,CCE-36270-7 | Ensure 'Network security: Force logoff when logon hours expire' is set to 'Enabled'"

- name: "CIS,2.3.11.7,CCE-36173-3 | Ensure 'Network security: LAN Manager authentication level' is set to 'Send NTLMv2 response only. Refuse LM & NTLM'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa
     name: "LMCompatibilityLevel"
     data: "5" # Send NTLMv2 responses only. Refuse LM & NTLM
     type: dword
  tags: ['configuration']

# The recommended state for this setting is 'Negotiate signing', but configuring this setting to 'Require signing' also conforms to the benchmark
- name: "CIS,2.3.11.8,CCE-36858-9 | Ensure 'Network security: LDAP client signing requirements' is set to 'Negotiate signing' or higher"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Services\Ldap
     name: "LDAPClientIntegrity"
     data: "1" # Negotiate signing
     type: dword
  tags: ['configuration']

# These values are dependent on the Network security: LAN Manager Authentication Level (2.3.11.7) security setting value
# Be aware that NTLM connections will fail if NTLMv2 protocol and strong encryption (128-bit) are not both negotiated
- name: "CIS,2.3.11.9,CCE-37553-5 | Ensure 'Network security: Minimum session security for NTLM SSP based (including secure RPC) clients' is set to 'Require NTLMv2 session security, Require 128-bit encryption'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa\Msv1_0
     name: "NTLMMinClientSec"
     data: "537395200"
     type: dword
  tags: ['configuration']

# These values are dependent on the Network security: LAN Manager Authentication Level (2.3.11.7) security setting value
# Be aware that NTLM connections will fail if NTLMv2 protocol and strong encryption (128-bit) are not both negotiated
- name: "CIS,2.3.11.10,CCE-37835-6 | Ensure 'Network security: Minimum session security for NTLM SSP based (including secure RPC) servers' is set to 'Require NTLMv2 session security, Require 128-bit encryption'"
  win_regedit:
     path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
     name: "NTLMMinServerSec"
     data: "537395200"
     type: dword
  tags: ['configuration']

# SYSTEM CRYPTOGRAPHY

# L2
# This recommendation 2.3.14.1 (Ensure 'System cryptography: Force strong key protection for user keys stored on the computer' is set to 'User is prompted when the key is first used' or higher) has a Level 2 profile applicability for High Security/Sensitive Data Environment (limited functionality)
- name: "CIS,2.3.14.1,CCE-37885-1 | Ensure Ensure 'System cryptography: Force strong key protection for user keys stored on the computer' is set to 'User is prompted when the key is first used' or higher"
  win_regedit:
     path: HKLM:\Software\Policies\Microsoft\Cryptography
     name: "ForceKeyProtection"
     data: "2" # User must enter a password each time they use a key
     type: dword
  when: (l2_environment|default(False) == True)
  tags: ['configuration']

# SYSTEM OBJECTS
- name: "CIS,2.3.15.1,CCE-37885-1 | Ensure 'System objects: Require case insensitivity for non-Windows subsystems' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Session Manager\Kernel
     name: "ObCaseInsensitive"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.15.2,CCE-37644-2 | Ensure 'System objects: Strengthen default permissions of internal system objects (e.g. Symbolic Links)' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\System\Currentcontrolset\Control\Session Manager
     name: "ProtectionMode"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

# USER ACCOUNT CONTROL

# If set to 'Enabled', it will forbid login with account Administrator credentials (built-in Administrator)
# Users that log on using the local Administrator account will be prompted for consent whenever a program requests an elevation in privilege, just like any other user would
# In any case, CIS recommends to have this setting enabled
- name: "CIS,2.3.17.1,CCE-36494-3 | Ensure 'User Account Control: Admin Approval Mode for the Built-in Administrator account' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "FilterAdministratorToken"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.17.2,CCE-37029-6 | Ensure 'User Account Control: Behavior of the elevation prompt for administrators in Admin Approval Mode' is set to 'Prompt for consent on the secure desktop'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "ConsentPromptBehaviorAdmin"
     data: '{{ prompt_for_consent_secure_desktop }}' # Prompt for consent on the secure desktop
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.17.3,CCE-36864-7 | Ensure 'User Account Control: Behavior of the elevation prompt for standard users' is set to 'Automatically deny elevation requests'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "ConsentPromptBehaviorUser"
     data: "0" # Automatically deny elevation requests
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.17.4,CCE-36533-8 | Ensure 'User Account Control: Detect application installations and prompt for elevation' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "EnableInstallerDetection"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.17.5,CCE-37057-7 | Ensure 'User Account Control: Only elevate UIAccess applications that are installed in secure locations' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "EnableSecureUIAPaths"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.17.6,CCE-36869-6 | Ensure 'User Account Control: Run all administrators in Admin Approval Mode' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "EnableLUA"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.17.7,CCE-36866-2 | Ensure 'User Account Control: Switch to the secure desktop when prompting for elevation' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "PromptOnSecureDesktop"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']

- name: "CIS,2.3.17.8,CCE-37064-3 | Ensure 'User Account Control: Virtualize file and registry write failures to per-user locations' is set to 'Enabled'"
  win_regedit:
     path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
     name: "EnableVirtualization"
     data: "1" # Enabled
     type: dword
  tags: ['configuration']